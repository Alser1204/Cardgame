<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ターン制カードゲーム</title>
<style>
  body { font-family: sans-serif; }
  #hand { display: flex; gap: 10px; margin-top: 10px; }
  .card { padding: 10px; border: 1px solid #000; cursor: pointer; background: #f5f5f5; }
  #messages { margin-top: 20px; max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 5px; }
</style>
</head>
<body>
<h1>ターン制カードゲーム</h1>

<div>
  名前: <input type="text" id="nameInput" placeholder="名前を入力">
  <button id="setNameBtn">設定</button>
</div>

<div>
  ルームID: <input type="text" id="roomInput" placeholder="room1">
  <button id="joinBtn">参加</button>
</div>

<h3>手札</h3>
<div id="hand"></div>

<h3>HP</h3>
<div id="hpDiv"></div>

<h3>メッセージ</h3>
<div id="messages"></div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
let myRoomId = null;

// 要素
const handDiv = document.getElementById("hand");
const messagesDiv = document.getElementById("messages");
const hpDiv = document.getElementById("hpDiv");

// 名前設定
document.getElementById("setNameBtn").onclick = () => {
  const name = document.getElementById("nameInput").value.trim();
  if (name) socket.emit("setName", name);
};

// ルーム参加
document.getElementById("joinBtn").onclick = () => {
  const roomId = document.getElementById("roomInput").value.trim();
  if (!roomId) return;
  myRoomId = roomId;
  socket.emit("joinRoom", roomId);
};

// メッセージ受信
socket.on("message", msg => {
  const div = document.createElement("div");
  div.textContent = msg;
  messagesDiv.appendChild(div);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
});

// HP更新
socket.on("updateHP", (hp, names) => {
  hpDiv.innerHTML = "";
  for (const id in hp) {
    const name = names[id] || id;
    const div = document.createElement("div");
    div.textContent = `${name}: HP ${hp[id]}`;
    hpDiv.appendChild(div);
  }
});

// ターン開始
socket.on("yourTurn", (hand, hp, names) => {
  renderHand(hand);
  // socket.emit("updateHP", hp, names); ←これ削除
  const div = document.createElement("div");
  div.textContent = "あなたのターンです。カードを選択してください。";
  messagesDiv.appendChild(div);
});


  socket.on("updateHand", (hand) => {
  renderHand(hand);
});

// ゲーム終了
socket.on("gameOver", winner => {
  alert(`ゲーム終了！勝者: ${winner}`);
  handDiv.innerHTML = "";
});

// 手札描画
function renderHand(hand) {
  handDiv.innerHTML = "";
  hand.forEach(card => {
    const div = document.createElement("div");
    div.className = "card";

    // 画像要素
    const img = document.createElement("img");
    img.src = `images/${card.name}.jpg`;  
    img.alt = card.name;
    img.style.width = "100px";
    img.style.height = "100px";       // 高さも幅に合わせて正方形
    img.style.objectFit = "cover";    // 縦横比を保ったまま正方形に収める
    img.style.display = "block";

    img.onerror = () => {
      img.src = "images/default.jpg";  // 代替画像
    };

    // カード説明（ツールチップ用文字列）
    let displayName = card.display_name || card.name;  // display_name があれば優先
    let desc = displayName;
    
    // 攻撃・回復・防御
    if (card.damage) desc += ` (攻撃${card.damage})`;
    if (card.heal) desc += ` (回復${card.heal})`;
    if (card.shield) desc += ` (防御${card.shield})`;
    
    // エフェクト説明
    if (card.effect) {
      switch(card.effect) {
        case "atkUp":
          desc += " (効果: 攻撃力アップ)";
          break;
        case "atkMultiplier":
          desc += ` (効果: 攻撃力 ×${card.multiplier})`;
          break;
        case "shieldUp":
          desc += " (効果: 防御力アップ)";
          break;
        case "shieldMultiplier":
          desc += ` (効果: 防御力 ×${card.multiplier})`;
          break;
        case "skipNextTurn":
          desc += " (効果: 次のターンスキップ)";
          break;
        case "drawCard":
          desc += ` (効果: カード${card.draw || 1}枚引く)`; // draw プロパティがあれば
          break;
        case "swapHand":
          desc += " (効果: 手札1枚交換)";
          break;
        case "multiTurn":
          desc += ` (効果: ${card.turns}ターン持続効果)`;
          break;
        default:
          desc += ` (効果: ${card.effect})`;
      }
    }

    // ツールチップ
    div.title = desc;

    // --- ラベル表示 ---
    const label = document.createElement("div");
    label.style.textAlign = "center";
    label.style.fontSize = "12px";
    label.style.marginTop = "4px";
    let labels = [];
    if (card.damage) labels.push("攻撃");
    if (card.heal) labels.push("回復");
    if (card.shield) labels.push("防御");
    if (card.effect) labels.push("効果");
    label.textContent = labels.join(" / ");
    div.appendChild(label);

    // クリック時の処理
    div.onclick = () => {
      if (!myRoomId) return;
      socket.emit("playCard", { roomId: myRoomId, cardName: card.name });
      handDiv.innerHTML = "";
      const infoDiv = document.createElement("div");
      infoDiv.textContent = "相手のターンです…";
      messagesDiv.appendChild(infoDiv);
    };

    div.appendChild(img);
    handDiv.appendChild(div);
  });
}
</script>
</body>
</html>
